machine:
  node:
    version: 4.1.0
  python:
    version: 3.4.2
  environment:
    DJANGO_SETTINGS_MODULE: cpdb.settings.test.circleci
    NODE_ENV: development
  post:
    - sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test && sudo apt-get update && sudo apt-get install gcc-4.9 g++-4.9
database:
  post:
    - psql -c "CREATE EXTENSION postgis;" -d circle_test
dependencies:
  override:
    - gem install sass
    - pip install -r requirements.txt
    - pyenv local 2.7.9
    - PYTHON=python2 npm install -g npm@3.5.1
    - PYTHON=python2 npm install -g bower@1.7.0
    - python manage.py bower_install
    - PYTHON=python2 npm install
    - PYTHON=python2 npm run circleci
    - PYTHON=python2 npm run circleci_admin
    - PYTHON=python2 npm run circleci_mobile
    - pyenv local 3.4.2
  cache_directories:
    - "bower_components"
test:
  pre:
    - python manage.py collectstatic --noinput
  override:
    - coverage run --parallel-mode manage.py test  --noinput --nologcapture --with-timer -s -v 2
    - npm test
  post:
    - coverage combine
    - coveralls
    - coverage report --omit="/home/ubuntu/virtualenvs/*,common/json_serializer.py"
